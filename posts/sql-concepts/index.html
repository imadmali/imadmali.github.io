<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Imad Ali ">
<meta name="description" content="Here&amp;rsquo;s a non-exhaustive laundry list of SQL concepts that I&amp;rsquo;ve found useful. You could think of them as intermediate? advanced? concepts that anyone doing data science or machine learning should probably know. I tried to order the concepts list is loosely in order of complexity, however that may vary from person to person.
All the examples here are done using the postgres Docker image available here (I talk about how to work with a postgres container in a separate post)." />
<meta name="keywords" content=", SQL, Data Engineering" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="http://imadali.net/posts/sql-concepts/" />


    <title>
        
            SQL Concepts :: Imad Ali 
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.min.07a025e14cdde3342fc8b7c30ba4e525ee670402dea60dfd9cec01cb2ee19e02.css">






<meta itemprop="name" content="SQL Concepts">
<meta itemprop="description" content="Here&rsquo;s a non-exhaustive laundry list of SQL concepts that I&rsquo;ve found useful. You could think of them as intermediate? advanced? concepts that anyone doing data science or machine learning should probably know. I tried to order the concepts list is loosely in order of complexity, however that may vary from person to person.
All the examples here are done using the postgres Docker image available here (I talk about how to work with a postgres container in a separate post)."><meta itemprop="datePublished" content="2020-10-29T16:14:19-07:00" />
<meta itemprop="dateModified" content="2020-10-29T16:14:19-07:00" />
<meta itemprop="wordCount" content="2251">
<meta itemprop="keywords" content="SQL,Data Engineering," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="SQL Concepts"/>
<meta name="twitter:description" content="Here&rsquo;s a non-exhaustive laundry list of SQL concepts that I&rsquo;ve found useful. You could think of them as intermediate? advanced? concepts that anyone doing data science or machine learning should probably know. I tried to order the concepts list is loosely in order of complexity, however that may vary from person to person.
All the examples here are done using the postgres Docker image available here (I talk about how to work with a postgres container in a separate post)."/>



    <meta property="og:title" content="SQL Concepts" />
<meta property="og:description" content="Here&rsquo;s a non-exhaustive laundry list of SQL concepts that I&rsquo;ve found useful. You could think of them as intermediate? advanced? concepts that anyone doing data science or machine learning should probably know. I tried to order the concepts list is loosely in order of complexity, however that may vary from person to person.
All the examples here are done using the postgres Docker image available here (I talk about how to work with a postgres container in a separate post)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://imadali.net/posts/sql-concepts/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-10-29T16:14:19-07:00" />
<meta property="article:modified_time" content="2020-10-29T16:14:19-07:00" />







    <meta property="article:published_time" content="2020-10-29 16:14:19 -0700 PDT" />








    </head>

    <body class="">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="http://imadali.net" style="text-decoration: none;">
    <div class="logo">
        
        
            <span class="logo__text">imad ali</span>
            <span class="logo__cursor" style=
                  "visibility:hidden;
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="http://imadali.net/posts/">Blog</a></li><li><a href="http://imadali.net/projects/">Projects</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <article>
            <h1 class="post-title">
                <a href="http://imadali.net/posts/sql-concepts/">SQL Concepts</a>
            </h1>

            <div class="post-info">
              <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2020-10-29
              </p>
              <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>11 minutes
              </p>
            </div>

            

            <div class="post-content">
                <p>Here&rsquo;s a non-exhaustive laundry list of SQL concepts that I&rsquo;ve found useful. You could think of them as intermediate? advanced? concepts that anyone doing data science or machine learning should probably know. I tried to order the concepts list is loosely in order of complexity, however that may vary from person to person.</p>
<p>All the examples here are done using the postgres Docker image available <a href="https://hub.docker.com/_/postgres">here</a> (I talk about how to work with a postgres container in a separate post). Below we create the table <code>synthetic</code> and populate it with data that I&rsquo;ll use to illustrate the various concepts.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> synthetic (id VARCHAR(<span style="color:#ae81ff">1</span>), var1 INT, var2 INT);
<span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> dim (id VARCHAR(<span style="color:#ae81ff">1</span>), meta VARCHAR(<span style="color:#ae81ff">100</span>));

<span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> synthetic (id, var1, var2)
<span style="color:#66d9ef">VALUES</span> (<span style="color:#e6db74">&#39;A&#39;</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>),
(<span style="color:#e6db74">&#39;A&#39;</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>),
(<span style="color:#e6db74">&#39;A&#39;</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span>),
(<span style="color:#e6db74">&#39;B&#39;</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">1</span>),
(<span style="color:#e6db74">&#39;B&#39;</span>, <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">0</span>),
(<span style="color:#e6db74">&#39;C&#39;</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">0</span>),
(<span style="color:#e6db74">&#39;C&#39;</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">1</span>),
(<span style="color:#e6db74">&#39;C&#39;</span>, <span style="color:#ae81ff">9</span>, <span style="color:#ae81ff">1</span>),
(<span style="color:#e6db74">&#39;D&#39;</span>, <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">0</span>);

<span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> dim (id, meta)
<span style="color:#66d9ef">VALUES</span> (<span style="color:#e6db74">&#39;A&#39;</span>, <span style="color:#e6db74">&#39;supercali&#39;</span>),
(<span style="color:#e6db74">&#39;B&#39;</span>, <span style="color:#e6db74">&#39;fragilistic&#39;</span>),
(<span style="color:#e6db74">&#39;C&#39;</span>, <span style="color:#e6db74">&#39;expiali&#39;</span>),
(<span style="color:#e6db74">&#39;D&#39;</span>, <span style="color:#e6db74">&#39;docious&#39;</span>),
(<span style="color:#e6db74">&#39;E&#39;</span>, <span style="color:#e6db74">&#39;!&#39;</span>);

<span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> synthetic;
</code></pre></div><pre tabindex="0"><code>id | var1 | var2
----+------+------
 A  |    1 |    1
 A  |    1 |    0
 A  |    2 |    1
 B  |    5 |    1
 B  |    8 |    0
 C  |    3 |    0
 C  |    4 |    1
 C  |    9 |    1
 D  |    7 |    0
</code></pre><h2 id="processing-order">Processing Order</h2>
<p>It&rsquo;s useful to know the processing order of a SQL query. It helps you understand when certain parts of your query are executed which will help you optimize your code. For example, if you only need to join data on a filtered set of rows then it might make sense to create CTEs that first filter the data and then perform joins using those CTEs.</p>
<p>Basically, the processing order of a SQL query goes something like this (see <a href="https://docs.microsoft.com/en-us/sql/t-sql/queries/select-transact-sql?redirectedfrom=MSDN&amp;view=sql-server-ver15">this</a> doc for more detail),</p>
<ol>
<li>FROM</li>
<li>JOIN</li>
<li>WHERE</li>
<li>GROUP BY</li>
<li>HAVING</li>
<li>SELECT (including aggregations, window functions, etc)</li>
<li>DISTINCT</li>
<li>ORDER BY</li>
<li>LIMIT</li>
</ol>
<h2 id="joins">Joins</h2>
<p>Joins are pretty basic and pretty fundamental. Sometimes (actually most of the time) your information is split across multiple tables and you need to join them together in order to get all the information in one place.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> a.id, b.meta
<span style="color:#66d9ef">FROM</span> synthetic a
<span style="color:#66d9ef">JOIN</span> dim b
<span style="color:#66d9ef">ON</span> a.id <span style="color:#f92672">=</span> b.id;
</code></pre></div><pre tabindex="0"><code>id |    meta
----+-------------
 A  | supercali
 A  | supercali
 A  | supercali
 B  | fragilistic
 B  | fragilistic
 C  | expiali
 C  | expiali
 C  | expiali
 D  | docious
</code></pre><p>There&rsquo;s also the anti-join. This can come in handy for problems when you want to select the records that don&rsquo;t have a match defined by the join. In this case we want any records that are in <code>dim</code> that are not in <code>synthetic</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> b.<span style="color:#f92672">*</span>
<span style="color:#66d9ef">FROM</span> synthetic a
<span style="color:#66d9ef">RIGHT</span> <span style="color:#66d9ef">JOIN</span> dim b
<span style="color:#66d9ef">ON</span> a.id <span style="color:#f92672">=</span> b.id
<span style="color:#66d9ef">WHERE</span> a.id <span style="color:#66d9ef">IS</span> <span style="color:#66d9ef">NULL</span>;
</code></pre></div><pre tabindex="0"><code>id | meta
----+------
 E  | !
</code></pre><p>Another way we could have done this anti-join is with <code>NOT IN</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span>
<span style="color:#66d9ef">FROM</span> dim
<span style="color:#66d9ef">WHERE</span> id <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">IN</span> (<span style="color:#66d9ef">SELECT</span> id <span style="color:#66d9ef">FROM</span> synthetic);
</code></pre></div><pre tabindex="0"><code>id | meta
----+------
 E  | !
</code></pre><h2 id="case-statements-conditionals">Case Statements (Conditionals)</h2>
<p>This allows you to implement if-else conditions on columns in your table. The typical formulation of case statements is <code>CASE WHEN &lt;condition&gt; THEN &lt;result&gt; ELSE &lt;result&gt; END &lt;new column name&gt;</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span>
	, <span style="color:#66d9ef">CASE</span> <span style="color:#66d9ef">WHEN</span> var2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">THEN</span> <span style="color:#e6db74">&#39;Y&#39;</span>
	       <span style="color:#66d9ef">WHEN</span> var2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">THEN</span> <span style="color:#e6db74">&#39;N&#39;</span>
	       <span style="color:#66d9ef">ELSE</span> <span style="color:#66d9ef">Null</span> <span style="color:#66d9ef">END</span> var3
<span style="color:#66d9ef">FROM</span> synthetic;
</code></pre></div><pre tabindex="0"><code>id | var1 | var2 | var3
----+------+------+------
 A  |    1 |    1 | Y
 A  |    1 |    0 | N
 A  |    2 |    1 | Y
 B  |    5 |    1 | Y
 B  |    8 |    0 | N
 C  |    3 |    0 | N
 C  |    4 |    1 | Y
 C  |    9 |    1 | Y
 D  |    7 |    0 | N
</code></pre><h2 id="group-by">Group By</h2>
<p>This is another obvious one. But because it&rsquo;s so commonly used it&rsquo;s worth mentioning. A <code>GROUP BY</code> enables you to apply aggregation functions (<code>COUNT</code>, <code>SUM</code>, <code>AVG</code>, etc) to parts of a table. These parts are provided by an identifier (or set of identifiers) which allows you to partition the data into groups that you want to apply your aggregation functions over.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> id
	, <span style="color:#66d9ef">COUNT</span>(<span style="color:#f92672">*</span>) id_count
	, <span style="color:#66d9ef">SUM</span>(var1) var1_sum
<span style="color:#66d9ef">FROM</span> synthetic
<span style="color:#66d9ef">GROUP</span> <span style="color:#66d9ef">BY</span> id;
</code></pre></div><pre tabindex="0"><code>id | id_count | var1_sum
----+----------+----------
 B  |        2 |       13
 C  |        3 |       16
 D  |        1 |        7
 A  |        3 |        4
</code></pre><h2 id="where-vs-having">Where vs Having</h2>
<p>Most people know of the <code>WHERE</code> statement. It allows you to filter (reduce the rows of your table) by a specific condition.</p>
<p>You can&rsquo;t use <code>WHERE</code> on a column that was created by an aggregate function. If you do you&rsquo;ll be performing the filter before the aggregation calculations take place. You can use the <code>HAVING</code> statement on a column created by an aggregate function to filter results after the aggregations have taken place.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span>
<span style="color:#66d9ef">FROM</span> synthetic
<span style="color:#66d9ef">WHERE</span> var1 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">5</span>;
</code></pre></div><pre tabindex="0"><code>id | var1 | var2
----+------+------
 A  |    1 |    1
 A  |    1 |    0
 A  |    2 |    1
 C  |    3 |    0
 C  |    4 |    1
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> id
	, <span style="color:#66d9ef">COUNT</span>(<span style="color:#f92672">*</span>) id_count
<span style="color:#66d9ef">FROM</span> synthetic
<span style="color:#66d9ef">WHERE</span> var1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">GROUP</span> <span style="color:#66d9ef">BY</span> id
<span style="color:#66d9ef">HAVING</span> id <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;A&#39;</span>;
</code></pre></div><pre tabindex="0"><code>id | id_count
----+----------
 A  |        2
</code></pre><h2 id="window-functions">Window Functions</h2>
<p>Window functions allow you to perform row-wise calculations on partitions (groups) of your data while allowing you to consider other rows in the calculation. This is useful when you want to create ranks, cumulative sums, rolling averages, etc. There is no group by aggregation taking place. The output table produced after applying a window function will always have the same number of rows as the original table.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> id
	, var1
	, RANK() OVER (<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> var1) var1_rank
	, LAG(var1, <span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">Null</span>) OVER (PARTITION <span style="color:#66d9ef">BY</span> Id <span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> var1) var1_lag
<span style="color:#66d9ef">FROM</span> synthetic
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> id, var1;
</code></pre></div><pre tabindex="0"><code>id | var1 | var1_rank | var1_lag
----+------+-----------+----------
 A  |    1 |         1 |
 A  |    1 |         1 |        1
 A  |    2 |         3 |        1
 B  |    5 |         6 |
 B  |    8 |         8 |        5
 C  |    3 |         4 |
 C  |    4 |         5 |        3
 C  |    9 |         9 |        4
 D  |    7 |         7 |
</code></pre><h2 id="rows-precedingfollowing">Rows Preceding/Following</h2>
<p>How do window functions know which data to consider before and/or after the row in question? It does this by using <code>ROWS # PRECEDING # FOLLOWING</code>, where # is how many rows you want the function to consider preceding/following the row you are currently at.</p>
<p>For example, to compute the cumulative sum we use the <code>SUM</code> window function and specify <code>ROWS UNBOUNDED PRECEDING</code>. This means that we are considering all previous rows (within the partition) in addition to the current row when calculating the cumulative sum. If we don&rsquo;t specify this then we&rsquo;ll just get the entire sum for each partition assigned to each row of the partition.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> id
	, var1
	, <span style="color:#66d9ef">SUM</span>(var1) OVER (PARTITION <span style="color:#66d9ef">BY</span> Id <span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> var1 <span style="color:#66d9ef">ROWS</span> UNBOUNDED PRECEDING) var1_cumsum_1
	, <span style="color:#66d9ef">SUM</span>(var1) OVER (PARTITION <span style="color:#66d9ef">BY</span> Id <span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> var1 <span style="color:#66d9ef">ROWS</span> <span style="color:#ae81ff">1</span> PRECEDING) var1_cumsum_2
<span style="color:#66d9ef">FROM</span> synthetic;
</code></pre></div><pre tabindex="0"><code>id | var1 | var1_cumsum_1 | var1_cumsum_2
----+------+---------------+---------------
 A  |    1 |             1 |             1
 A  |    1 |             2 |             2
 A  |    2 |             4 |             3
 B  |    5 |             5 |             5
 B  |    8 |            13 |            13
 C  |    3 |             3 |             3
 C  |    4 |             7 |             7
 C  |    9 |            16 |            13
 D  |    7 |             7 |             7
</code></pre><p>Here&rsquo;s what happens if we don&rsquo;t provide <code>PRECEDING</code> or <code>FOLLOWING</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> id
	, var1
	, <span style="color:#66d9ef">SUM</span>(var1) OVER (PARTITION <span style="color:#66d9ef">BY</span> Id <span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> var1) var1_cumsum_1
	, <span style="color:#66d9ef">SUM</span>(var1) OVER (PARTITION <span style="color:#66d9ef">BY</span> Id <span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> var1) var1_cumsum_2
<span style="color:#66d9ef">FROM</span> synthetic;
</code></pre></div><pre tabindex="0"><code>id | var1 | var1_cumsum_1 | var1_cumsum_2
----+------+---------------+---------------
 A  |    1 |             2 |             2
 A  |    1 |             2 |             2
 A  |    2 |             4 |             4
 B  |    5 |             5 |             5
 B  |    8 |            13 |            13
 C  |    3 |             3 |             3
 C  |    4 |             7 |             7
 C  |    9 |            16 |            16
 D  |    7 |             7 |             7
</code></pre><h2 id="rank-vs-dense-rank-vs-row-number">Rank vs Dense Rank vs Row Number</h2>
<p>This one always trips me up. Dense rank and rank will be the same except when there are ties. In tie situations dense will always give you consecutive ranks (no gaps in ranking values) where as rank will skip ranks in situations where there are ties.</p>
<p>Rank is similar to row number, however rank provides the same value in situations where there are ties.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> id
	, var1
	, RANK() OVER (<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> var1) var1_rank
	, DENSE_RANK() OVER (<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> var1) var1_dense_rank
	, ROW_NUMBER() OVER (<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> var1) var1_row_number
<span style="color:#66d9ef">FROM</span> synthetic
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> var1;
</code></pre></div><pre tabindex="0"><code>id | var1 | var1_rank | var1_dense_rank | var1_row_number
----+------+-----------+-----------------+-----------------
 A  |    1 |         1 |               1 |               1
 A  |    1 |         1 |               1 |               2
 A  |    2 |         3 |               2 |               3
 C  |    3 |         4 |               3 |               4
 C  |    4 |         5 |               4 |               5
 B  |    5 |         6 |               5 |               6
 D  |    7 |         7 |               6 |               7
 B  |    8 |         8 |               7 |               8
 C  |    9 |         9 |               8 |               9
</code></pre><h2 id="views">Views</h2>
<p>A view represents a table. It&rsquo;s not a table that&rsquo;s stored on disk. Rather the SQL code to construct the table is stored. Typically, every time you call a view, the SQL code that defines that view is executed to generate the table. (I say typically since sometimes the results can be stored/read from a cache). You&rsquo;ll notice that a view is not stored in the &ldquo;Table&rdquo; section of the database, but in a separate &ldquo;View&rdquo; section&hellip; because it ain&rsquo;t a table.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">VIEW</span> synthetic_agg <span style="color:#66d9ef">AS</span>
<span style="color:#66d9ef">SELECT</span> id
	, <span style="color:#66d9ef">COUNT</span>(<span style="color:#f92672">*</span>) id_count
<span style="color:#66d9ef">FROM</span> synthetic
<span style="color:#66d9ef">GROUP</span> <span style="color:#66d9ef">BY</span> id;

<span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> synthetic_agg;
</code></pre></div><pre tabindex="0"><code>id | id_count
----+----------
 B  |        2
 C  |        3
 D  |        1
 A  |        3
</code></pre><h2 id="user-defined-functions">User Defined Functions</h2>
<p>Just as in any programing language, functions in SQL allow you to parameterize your query. The way you specify functions will vary depending on the variant of SQL used by your choice of SQL server provider.</p>
<p>Here&rsquo;s a function that returns a filtered table that has the same schema as the <code>synthetic</code> table.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">OR</span> <span style="color:#66d9ef">REPLACE</span> <span style="color:#66d9ef">FUNCTION</span> synthetic_filter(param INT)
<span style="color:#66d9ef">RETURNS</span> <span style="color:#66d9ef">SETOF</span> synthetic
<span style="color:#66d9ef">AS</span>
<span style="color:#960050;background-color:#1e0010">$$</span>
	<span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span>
	<span style="color:#66d9ef">FROM</span> synthetic
	<span style="color:#66d9ef">WHERE</span> var1 <span style="color:#f92672">=</span> param;
<span style="color:#960050;background-color:#1e0010">$$</span>
<span style="color:#66d9ef">LANGUAGE</span> <span style="color:#66d9ef">SQL</span>;
</code></pre></div><pre tabindex="0"><code>id | var1 | var2
----+------+------
 A  |    1 |    1
 A  |    1 |    0
</code></pre><p>Here&rsquo;s a function that returns a schema that&rsquo;s different from the <code>synthetic</code> table (we have to define the schema of the returning table).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">OR</span> <span style="color:#66d9ef">REPLACE</span> <span style="color:#66d9ef">FUNCTION</span> synthetic_grouped(param INT)
<span style="color:#66d9ef">RETURNS</span> <span style="color:#66d9ef">TABLE</span> (id VARCHAR(<span style="color:#ae81ff">1</span>), id_count INT)
<span style="color:#66d9ef">AS</span>
<span style="color:#960050;background-color:#1e0010">$$</span>
	<span style="color:#66d9ef">SELECT</span> id, <span style="color:#66d9ef">COUNT</span>(<span style="color:#f92672">*</span>) id_count
	<span style="color:#66d9ef">FROM</span> synthetic
	<span style="color:#66d9ef">WHERE</span> var2 <span style="color:#f92672">=</span> param
	<span style="color:#66d9ef">GROUP</span> <span style="color:#66d9ef">BY</span> id;
<span style="color:#960050;background-color:#1e0010">$$</span>
<span style="color:#66d9ef">LANGUAGE</span> <span style="color:#66d9ef">SQL</span>;

<span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> synthetic_grouped(<span style="color:#ae81ff">1</span>);
</code></pre></div><pre tabindex="0"><code>id | id_count
----+----------
 A  |        2
 B  |        1
 C  |        2
</code></pre><p>Finally, here&rsquo;s a function that returns a single value (in this case a <code>VARCHAR</code>). These return types  are useful to define complicated row-wise operations or for operations that need to be reused.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">CREATE OR REPLACE FUNCTION var2_condition(param INT)
RETURNS VARCHAR(<span style="color:#ae81ff">1</span>)
AS
<span style="color:#960050;background-color:#1e0010">$$</span>
	SELECT CASE WHEN param <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> THEN <span style="color:#e6db74">&#39;Y&#39;</span>
	       WHEN param <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> THEN <span style="color:#e6db74">&#39;N&#39;</span>
	       ELSE Null END;
<span style="color:#960050;background-color:#1e0010">$$</span>
LANGUAGE SQL;

SELECT <span style="color:#f92672">*</span>, var2_condition(var2) var2_char
FROM synthetic;
</code></pre></div><pre tabindex="0"><code>id | var1 | var2 | var2_char
----+------+------+-----------
 A  |    1 |    1 | Y
 A  |    1 |    0 | N
 A  |    2 |    1 | Y
 B  |    5 |    1 | Y
 B  |    8 |    0 | N
 C  |    3 |    0 | N
 C  |    4 |    1 | Y
 C  |    9 |    1 | Y
 D  |    7 |    0 | N
</code></pre><h2 id="cte-common-table-expression">CTE (Common Table Expression)</h2>
<p>CTEs allow you to reference a table created by one query in another query, without having to write the table to disk (in other words you don&rsquo;t have to use <code>CREATE TABLE</code>). Basically you&rsquo;re keeping the table in memory temporarily.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">WITH</span> tmp_table <span style="color:#66d9ef">AS</span> (
	<span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span>
	<span style="color:#66d9ef">FROM</span> synthetic
	<span style="color:#66d9ef">WHERE</span> var2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
)

<span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span>
<span style="color:#66d9ef">FROM</span> tmp_table;
</code></pre></div><pre tabindex="0"><code>id | var1 | var2
----+------+------
 A  |    1 |    1
 A  |    2 |    1
 B  |    5 |    1
 C  |    4 |    1
 C  |    9 |    1
</code></pre><h2 id="knowing-when-to-write-a-table-to-disk">Knowing When to Write a Table to Disk</h2>
<p>Sometimes it&rsquo;s obvious when to create a table. Typically you&rsquo;ll do it when you want to share the result with someone or some service. But sometimes it&rsquo;s worth breaking up a complicated ETL workflow into tables that are written to disk. This helps you do QA on different components of the ETL workflow. It also helps when a part of the workflow errors out for some reason. You don&rsquo;t have to start the entire ETL workflow from the beginning. The process can just start at the point where the error took place. Just make sure you clean up tables that aren&rsquo;t actively being used so that they don&rsquo;t unnecessarily consume space.</p>
<p>It&rsquo;s important to know the tradeoffs though. Writing to disk can be slower since you have to spend time writing/reading from disk. Keeping things in memory circumvents this inefficiency&hellip; at the expense of holding the data in memory (typically you have more space on disk than you do in memory). If your code errors out and you kept all your data in memory then whatever transformations you did to that data won&rsquo;t be saved.</p>

            </div>
        </article>

        <div class="post-info">
                <p>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="http://imadali.net/tags/sql">SQL</a></span><span class="tag"><a href="http://imadali.net/tags/data-engineering">Data Engineering</a></span>
                </p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>2251 Words</p>
        </div>

        
    </main>

            </div>

            
                <footer class="footer">
    
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy 2020 Imad Ali</span>
            <span>Powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://github.com/rhazdon/hugo-theme-hello-friend-ng">Hello Friend NG</a></span>
        </div>
    </div>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"
    onload='renderMathInElement(document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "\\[", right: "\\]", display: true},
            {left: "$", right: "$", display: false},
            {left: "\\(", right: "\\)", display: false}
        ]
    });'></script>

    
</footer>

            
        </div>

        




<script type="text/javascript" src="/bundle.min.59ecdc8ddd50b30e6dd7ad4a5372c3fd24a26db671cc1575443b150ceb9d4bc8e73618fb298596b5c336cf5d8c2db90bd7e72a648479e97884e5398722f962fa.js" integrity="sha512-Wezcjd1Qsw5t161KU3LD/SSibbZxzBV1RDsVDOudS8jnNhj7KYWWtcM2z12MLbkL1&#43;cqZIR56XiE5TmHIvli&#43;g=="></script>



    </body>
</html>
